---
AWSTemplateFormatVersion: '2010-09-09'
Description: Account onboarding cross account IAM roles and Policies
Parameters:
  AccountAlias:
    Description: Enter your account alias name
    Type: String
Resources:
  IdentityProvider:
    Type: Custom::IdentityProvider
    Properties:
      ServiceToken: !GetAtt ProviderCreator.Arn
      Region: !Ref "AWS::Region"
      Metadata: !Sub |
          <?xml version="1.0" encoding="UTF-8" standalone="no"?> <md:EntityDescriptor xmlns:md="urn:oasis:names:tc:SAML:2.0:metadata" entityID="https://accounts.google.com/o/saml2?idpid=C03hataxg" validUntil="2023-05-08T20:37:51.000Z"> <md:IDPSSODescriptor WantAuthnRequestsSigned="false" protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"> <md:KeyDescriptor use="signing"> <ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"> <ds:X509Data> <ds:X509Certificate>MIIDdDCCAlygAwIBAgIGAWNGn+eXMA0GCSqGSIb3DQEBCwUAMHsxFDASBgNVBAoTC0dvb2dsZSBJ bmMuMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MQ8wDQYDVQQDEwZHb29nbGUxGDAWBgNVBAsTD0dv b2dsZSBGb3IgV29yazELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWEwHhcNMTgwNTA5 MjAzNzUxWhcNMjMwNTA4MjAzNzUxWjB7MRQwEgYDVQQKEwtHb29nbGUgSW5jLjEWMBQGA1UEBxMN TW91bnRhaW4gVmlldzEPMA0GA1UEAxMGR29vZ2xlMRgwFgYDVQQLEw9Hb29nbGUgRm9yIFdvcmsx CzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A MIIBCgKCAQEAuPb6HE91NxSUByyc95G43S41BqXgDHiAr5pyh3rwlFaIr3RZoEXvnjBRIm7xPpWo Er8cqjbtbir27ZVVOrszUwqarTw0hZ23p+CfeJVYTjdwU0kCVAwb16Gs3PoFdpuRNYcW54ps+MqQ 0Qxf37ZAjNMk/UMaizakfLTHRhqtCwVWAerwnrnWjL2hVrXB/oSMaLduMg2plCgnNv4KJo8SvEcP 5NcIDjzWetobcPzb4MWMrIrmGKxZdnHSBnNi29RLOLca1WowacTN7vcyxBMu0jAv4vYHMzBVxoZw xhk24CCnNBNgtwY2tcVu2Ndd8rB1FNOneUvTYEVjjrv2a+XOjwIDAQABMA0GCSqGSIb3DQEBCwUA A4IBAQB8JQq6zUy7nWnzmCBU8nqTNjkA4BCCK19EIadftQF0V6LSnZfqpUQrttPG0E9V54R7KGoG hBw7XLW6tPoAzR2DCF7fMuNog70Uv3B2LUvpJ1vuNQrddFbMqxah21Zm3nP/DeaDRIvfFS+bw7iq VjnAG1Qfg8KPkJUkIxqaOBBk7gsb6JK5BS6jMRJNZSjMGI05Q3x7J7ZXOZ/MfeKQiO89/h98XkiB lvep1EJOvfmC86+1mvffJAkELORcioTh99a/voqYFtqQHrYDzDEyaRiGSAY4fMHPacIEYljKz5/r fb7H7XWQ8X9tDl0fgY2N1TgmYUwxwL0SIyKoiK39witH</ds:X509Certificate> </ds:X509Data> </ds:KeyInfo> </md:KeyDescriptor> <md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</md:NameIDFormat> <md:SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect" Location="https://accounts.google.com/o/saml2/idp?idpid=C03hataxg"/> <md:SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" Location="https://accounts.google.com/o/saml2/idp?idpid=C03hataxg"/> </md:IDPSSODescriptor> </md:EntityDescriptor>
      Name: "Gsuite"
  ProviderCreator:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python2.7
      Handler: index.lambda_handler
      MemorySize: 128
      Role: !GetAtt ProviderCreatorLambdaExecutionRole.Arn
      Timeout: 30
      Code:
        ZipFile: !Sub |

          import boto3
          from botocore.exceptions import ClientError
          import json
          import cfnresponse

          iam = boto3.client("iam")

          def create_provider(name, doc):
            try:
              resp = iam.create_saml_provider(SAMLMetadataDocument=doc,Name=name)
              return(True, resp['SAMLProviderArn'])
            except Exception as e:
              return (False, "Cannot create SAML provider: " + str(e))

          def delete_provider(arn):
            try:
              resp = iam.delete_saml_provider(SAMLProviderArn=arn)
              return (True, "SAML provider with ARN " + arn + " deleted")
            except ClientError as e:
              if e.response['Error']['Code'] == "NoSuchEntity":
                # no need to delete a thing that doesn't exist
                return (True, "SAML provider with ARN " + arn + " does not exist, deletion succeeded")
              else:
                return (False, "Cannot delete SAML provider with ARN " + arn + ": " + str(e))
            except Exception as e:
              return (False, "Cannot delete SAML provider with ARN " + arn + ": " + str(e))

          def update_provider(arn, doc):
            # Need to create the ARN from the name
            arn = "arn:aws:iam::" + context.invoked_function_arn.split(':')[4] + ":saml-provider/" + name
            try:
              resp = iam.update_saml_provider(SAMLMetadataDocument=doc, SAMLProviderArn=arn)
              return (True, "SAML provider " + arn + " updated")
            except Exception as e:
              return (False, "Cannot update SAML provider " + arn + ": " + str(e))

          def lambda_handler(event, context):
            provider_xml = event['ResourceProperties']['Metadata']
            provider_name = event['ResourceProperties']['Name']
            # create a default ARN from the name; will be overwritten if we are creating
            provider_arn = "arn:aws:iam::" + context.invoked_function_arn.split(':')[4] + ":saml-provider/" + provider_name

            if event['RequestType'] == 'Create':
              res, provider_arn = create_provider(provider_name, provider_xml)
              reason = "Creation succeeded"
            elif event['RequestType'] == 'Update':
              res, reason = update_provider(provider_arn, provider_xml)
            elif event['RequestType'] == 'Delete':
              res, reason = delete_provider(provider_arn)
            else:
              res = False
              resp = "Unknown operation: " + event['RequestType']

            responseData = {}
            responseData['Reason'] = reason
            if res:
              cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, provider_arn)
            else:
              cfnresponse.send(event, context, cfnresponse.FAILED, responseData, provider_arn)

  ProviderCreatorLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - iam:*SamlProvider
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
  AdminRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Join:
        - ''
        - - AWS_
          - Ref: AccountAlias
          - _Admin_
          - Ref: AWS::AccountId
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Sid: ''
          Principal:
            Federated:
              Fn::Join:
              - ''
              - - 'arn:aws:iam::'
                - Ref: AWS::AccountId
                - ":saml-provider/Gsuite"
          Action: sts:AssumeRoleWithSAML
          Condition:
            StringEquals:
              SAML:aud: https://signin.aws.amazon.com/saml

  AdminPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
            - Effect: Allow
              Resource: "*"
              Action:
                - ec2:Describe*
                - ec2:Get*
                - ec2:List*
                - health:Describe*
                - health:Get*
                - health:List*
                - iam:List*
                - iam:Generate*
                - iam:Get*
                - iam:Simulate
                - elasticloadbalancing:Describe*
                - cloudwatch:Get*
                - cloudwatch:List*
                - cloudwatch:Describe*
                - trustedadvisor:Describe*
                - kms:Describe*
                - kms:Get*
                - kms:List*
                - rds:Describe*
                - rds:List*
                - pi:DescribeDimensionKeys
                - pi:GetResourceMetrics
                - aws-portal:ViewAccount
                - aws-portal:ViewBilling
                - aws-portal:ViewUsage
                - aws-portal:ViewBudget
                - aws-portal:ViewPaymentMethods
                - elasticache:Describe*
                - elasticache:List*
                - route53:Get*
                - route53:List*
                - route53:Test*
                - route53domains:Check*
                - route53domains:Get*
                - route53domains:List*
                - route53domains:View*
                - apigateway:GET
                - cloudfront:Get*
                - cloudfront:List*
                - elasticbeanstalk:Check*
                - elasticbeanstalk:Describe*
                - elasticbeanstalk:List*
                - elasticbeanstalk:Request*
                - elasticbeanstalk:Retrieve*
                - elasticbeanstalk:Validate*
                - s3:Get*
                - s3:List*
                - s3:Head*
                - autoscaling:Describe*
                - resource-groups:Describe*
                - resource-groups:Get*
                - resource-groups:List*
                - resource-groups:Search*
                - cloudtrail:Get*
                - cloudtrail:Describe*
                - cloudtrail:LookupEvents
                - cloudtrail:List*
                - config:Describe*
                - config:Get*
                - config:List*
                - config:BatchGet*
                - cloudformation:Describe*
                - cloudformation:Detect*
                - cloudformation:Get*
                - cloudformation:List*
                - cloudformation:Estimate*
                - cloudformation:Preview*
                - events:Describe*
                - events:List*
                - events:Test*
                - lambda:List*
                - lambda:Get*
                - sns:Get*
                - sns:List*
                - sns:Check*
                - sqs:Get*
                - sqs:List*
                - sqs:Receive*
                - acm:Describe*
                - acm:Get*
                - acm:List*
                - dynamodb:BatchGet*
                - dynamodb:Describe*
                - dynamodb:Get*
                - dynamodb:List*
                - dynamodb:Query
                - dynamodb:Scan
                - ds:Get*
                - ds:List*
                - ds:Describe*
                - gamelift:List*
                - gamelift:Get*
                - gamelift:Describe*
                - gamelift:RequestUploadCredentials
                - gamelift:ResolveAlias
                - gamelift:Search*
                - servicequotas:Get*
                - servicequotas:List*
                - ecs:DescribeClusters
                - ecs:ListClusters
                - ecs:ListContainerInstances
                - ecs:ListServices
                - ecs:ListTaskDefinitions
                - ecs:ListTasks
                - dax:BatchGetItem
                - dax:Describe*
                - dax:GetItem
                - dax:ListTags
                - dax:Query
                - dax:Scan
                - sts:Get*
                - redshift:Describe*
                - redshift:GetReservedNodeExchangeOfferings
                - redshift:View*
                - es:List*
                - es:Get*
                - es:Describe*
                - waf:Get*
                - waf:List*
                - waf-regional:List*
                - waf-regional:Get*
                - kinesisanalytics:Describe*
                - kinesisanalytics:Discover*
                - kinesisanalytics:Get*
                - kinesisanalytics:List*
                - kinesisvideo:Describe*
                - kinesisvideo:Get*
                - kinesisvideo:List*
                - kinesis:Describe*
                - kinesis:Get*
                - kinesis:List*
                - codedeploy:BatchGet*
                - codedeploy:Get*
                - codedeploy:List*
                - ecs:Describe*
                - ecs:List*
                - firehose:Describe*
                - firehose:List*
                - states:List*
                - states:Describe*
                - states:GetExecutionHistory
                - ssm:Describe*
                - ssm:Get*
                - ssm:List*
                - glue:Get*
                - athena:List*
                - athena:Batch*
                - athena:Get*
                - ram:List*
                - ram:Get*
                - clouddirectory:List*
                - clouddirectory:BatchRead
                - clouddirectory:Get*
                - clouddirectory:LookupPolic
                - dlm:Get*
                - cognito-idp:AdminGet*
                - cognito-idp:AdminList*
                - cognito-idp:List*
                - cognito-idp:Describe*
                - cognito-idp:Get*
                - codepipeline:List*
                - codepipeline:Get*
                - dms:Describe*
                - dms:List*
                - dms:Test*
                - discovery:Describe*
                - discovery:List*
                - discovery:Get*
                - elasticmapreduce:Describe*
                - elasticmapreduce:List*
                - elasticmapreduce:View*
                - elasticfilesystem:Describe*
                - securityhub:List*
                - serverlessrepo:List*
                - serverlessrepo:Get*
                - serverlessrepo:SearchApplications
                - codebuild:BatchGet*
                - codebuild:List*
                - codecommit:BatchGet*
                - codecommit:Describe*
                - codecommit:Get*
                - codecommit:GitPull
                - codecommit:List*
                - sso:Get*
                - sso:List*
                - sso:Describe*
                - sso:Search*
                - connect:List*
                - connect:Describe*
                - devicefarm:List*
                - devicefarm:Get*
                - xray:BatchGet*
                - xray:Get*
                - servicediscovery:Get*
                - servicediscovery:List*
                - appmesh:Get*
                - appmesh:List*
                - polly:Describe*
                - polly:Get*
                - polly:List*
                - polly:SynthesizeSpeech
                - ses:Get*
                - ses:List*
                - ses:Describe*
                - acm-pca:List*
                - acm-pca:Get*
                - acm-pca:Describe*
                - glacier:List*
                - glacier:Describe*
                - glacier:Get*
                - sagemaker:Describe*
                - sagemaker:List*
                - aws-marketplace:List*
                - cloud9:Describe*
                - cloud9:List*
                - appsync:Get*
                - appsync:List*
                - rekognition:CompareFaces
                - rekognition:Detect*
                - rekognition:List*
                - rekognition:Search
      Roles:
      - Ref: AdminRole

  DevOpsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Join:
          - ''
          - - AWS_
            - Ref: AccountAlias
            - _Developer_
            - Ref: AWS::AccountId
      AssumeRolePolicyDocument:
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Federated:
              Fn::Join:
              - ''
              - - 'arn:aws:iam::'
                - Ref: AWS::AccountId
                - ":saml-provider/Gsuite"
          Action: sts:AssumeRoleWithSAML
          Condition:
            StringEquals:
              SAML:aud: https://signin.aws.amazon.com/saml

  IAMDevOpsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
            - Effect: Allow
              Resource: "*"
              Action:
                - iam:Generate*
                - iam:Get*
                - iam:List*
                - iam:Simulate*
                - health:Describe*
                - athena:Get*
                - athena:List*
                - athena:Batch*
                - s3:List*
                - s3:Get*
                - s3:HeadBucket
                - s3:DescribeJob
                - glue:Get*
                - glue:Batch*
                - glue:TagResource
                - glue:List*
                - glue:Get*
                - sts:Get*
                - ec2:Get*
                - ec2:List*
                - ec2:Describe*
                - sns:ListTopics
                - sns:GetTopicAttributes
                - sns:ListTagsForResource
                - sns:List*
                - sns:Get*
                - sns:CheckIfPhoneNumberIsOptedOut
                - sns:List*
                - logs:ListTagsLogGroup
                - logs:Describe*
                - logs:Get*
                - logs:StartQuery
                - logs:StopQuery
                - logs:TestMetricFilter
                - logs:Get*
                - logs:FilterLogEvents
                - cloudwatch:DescribeAlarmHistory
                - cloudwatch:Get*
                - cloudwatch:Describe*
                - cloudwatch:List*
                - autoscaling:DescribeAutoScalingNotificationTypes
                - autoscaling:Describe*
                - application-autoscaling:Describe*
                - resource-groups:GetGroupQuery",
                - resource-groups:Search*
                - resource-groups:List*
                - kms:Get*
                - kms:Describe*
                - kms:List*
                - cloudtrail:Get*
                - cloudtrail:DescribeTrails
                - cloudtrail:LookupEvents
                - cloudtrail:List*
                - states:List*
                - states:Describe*
                - states:GetExecutionHistory
                - ssm:List*
                - ssm:Describe*
                - ssm:Get*
                - ssm:PutConfigurePackageResult
                - ssm:List*
                - sqs:List*
                - sqs:Get*
                - sqs:ReceiveMessage
                - organizations:List*
                - organizations:Describe*
                - lambda:List*
                - lambda:Get*
                - kinesis:List*
                - kinesis:SubscribeToShard
                - kinesis:Describe*
                - kinesis:Get*
                - firehose:Describe*
                - firehose:List*
                - events:Describe*
                - events:List*
                - events:TestEventPattern
                - ecs:List*
                - ecs:Describe*
                - codedeploy:Get*
                - codedeploy:Batch*
                - codedeploy:List*
                - tag:Get*
                - cloudformation:List*
                - cloudformation:Describe*
                - cloudformation:Detect*
                - cloudformation:EstimateTemplateCost
                - cloudformation:Get*
                - ses:List*
                - ses:Verify*
                - ses:Get*
                - ses:Describe*
                - elasticloadbalancing:Describe*
                - robomaker:List*
                - robomaker:Batch*
                - robomaker:Describe*
                - greengrass:List*
                - greengrass:Get*
                - cloud9:List*
                - cloud9:Describe*
                - rds:Describe*
                - kinesisvideo:List*
                - kinesisvideo:Get*
                - kinesisvideo:DescribeStream
                - kinesisanalytics:List*
                - kinesisanalytics:DiscoverInputSchema
                - kinesisanalytics:DescribeApplication
                - sagemaker:List*
                - sagemaker:Describe*
                - sagemaker:Search
                - sagemaker:InvokeEndpoint
                - sagemaker:Describe*
                - sagemaker:RenderUiTemplate
                - elasticfilesystem:Describe*
                - route53:List*
                - route53:Get*
                - route53:TestDNSAnswer
                - datapipeline:Get*
                - datapipeline:EvaluateExpression
                - datapipeline:ListPipelines
                - datapipeline:QueryObjects
                - datapipeline:Describe*
                - datapipeline:ValidatePipelineDefinition
                - pi:Describe*
                - pi:Get*
                - dynamodb:BatchGetItem
                - dynamodb:ConditionCheckItem
                - dynamodb:List*
                - dynamodb:Scan
                - dynamodb:Query
                - dynamodb:Describe*
                - dynamodb:Get*
                - secretsmanager:Get*
                - secretsmanager:DescribeSecret
                - secretsmanager:List*
                - config:Get*
                - config:Describe*
                - config:SelectResourceConfig
                - config:Batch*
                - config:List*
                - ecr:Get*
                - ecr:Batch*
                - ecr:Describe*
                - ecr:List*
                - waf-regional:Get*
                - waf-regional:List*
                - dlm:Get*
                - elasticache:Describe*
                - elasticache:List*
                - trustedadvisor:Describe*
                - codebuild:Batch*
                - codebuild:List*
                - codepipeline:List*
                - codepipeline:Get*
                - opsworks:Describe*
                - opsworks:List*
                - opsworks:GetHostnameSuggestion
                - codecommit:Get*
                - codecommit:List*
                - codecommit:Describe*
                - codecommit:BatchDescribeMergeConflicts
                - codecommit:BatchGetCommits
                - codecommit:CancelUploadArchive
                - dms:Describe*
                - dms:List*
                - dms:TestConnection
                - cloudfront:Get*
                - cloudfront:List*
                - waf:List*
                - waf:Get*
                - acm:ExportCertificate
                - acm:DescribeCertificate
                - acm:GetCertificate
                - acm:List*
                - applicationinsights:Describe*
                - applicationinsights:List*
      Roles:
      - Ref: DevOpsRole

  DevOpsBotRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Join:
          - ''
          - - AWS_
            - Ref: AccountAlias
            - _Developer_
            - Ref: AWS::AccountId
      AssumeRolePolicyDocument:
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Federated:
              Fn::Join:
              - ''
              - - 'arn:aws:iam::'
                - Ref: AWS::AccountId
                - ":saml-provider/Gsuite"
          Action: sts:AssumeRoleWithSAML
          Condition:
            StringEquals:
              SAML:aud: https://signin.aws.amazon.com/saml

  IAMDevOpsBotPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
            - Effect: Allow
              Resource: "*"
              Action:
                - sts:Get*
                - s3:List*
                - s3:Get*
                - s3:HeadBucket
                - s3:DescribeJob
                - rds:Describe*
                - elasticache:Describe*
                - elasticache:List*
                - ec2:Get*
                - ec2:List*
                - ec2:Describe*
      Roles:
      - Ref: DevOpsBotRole

  DataScienceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Join:
          - ''
          - - AWS_
            - Ref: AccountAlias
            - _Developer_
            - Ref: AWS::AccountId
      AssumeRolePolicyDocument:
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Federated:
              Fn::Join:
              - ''
              - - 'arn:aws:iam::'
                - Ref: AWS::AccountId
                - ":saml-provider/Gsuite"
          Action: sts:AssumeRoleWithSAML
          Condition:
            StringEquals:
              SAML:aud: https://signin.aws.amazon.com/saml

  IAMDataSciencePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
            - Effect: Allow
              Resource: "*"
              Action:
                - logs:ListTagsLogGroup
                - logs:Describe*
                - logs:Get*
                - logs:StartQuery
                - logs:StopQuery
                - logs:TestMetricFilter
                - logs:Get*
                - logs:FilterLogEvents
                - lambda:List*
                - lambda:Get*
                - kms:Get*
                - kms:Describe*
                - kms:List*
                - cloudwatch:DescribeAlarmHistory
                - cloudwatch:Get*
                - cloudwatch:Describe*
                - cloudwatch:List*
                - sns:ListTopics
                - sns:GetTopicAttributes
                - sns:ListTagsForResource
                - sns:List*
                - sns:Get*
                - sns:CheckIfPhoneNumberIsOptedOut
                - sns:List*
                - s3:List*
                - s3:Get*
                - s3:HeadBucket
                - s3:DescribeJob
                - glue:Get*
                - glue:Batch*
                - glue:TagResource
                - glue:List*
                - glue:Get*
                - ec2:Get*
                - ec2:List*
                - ec2:Describe*
                - iam:Generate*
                - iam:Get*
                - iam:List*
                - iam:Simulate*
                - sagemaker:List*
                - sagemaker:Describe*
                - sagemaker:Search
                - sagemaker:InvokeEndpoint
                - sagemaker:Describe*
                - sagemaker:RenderUiTemplate
                - cloudformation:List*
                - cloudformation:Describe*
                - cloudformation:Detect*
                - cloudformation:EstimateTemplateCost
                - cloudformation:Get*
                - athena:Get*
                - athena:List*
                - athena:Batch*
                - route53:List*
                - route53:Get*
                - route53:TestDNSAnswer
                - health:Describe*
                - redshift:FetchResults
                - redshift:GetReservedNodeExchangeOfferings
                - redshift:Describe*
                - redshift:List*
                - redshift:View*
                - tag:Get*
                - elasticloadbalancing:Describe*
                - elasticbeanstalk:Describe*
                - elasticbeanstalk:ValidateConfigurationSettings
                - elasticbeanstalk:CheckDNSAvailability
                - elasticbeanstalk:List*
                - elasticbeanstalk:RequestEnvironmentInfo
                - elasticbeanstalk:RetrieveEnvironmentInfo
                - cloudfront:Get*
                - cloudfront:List*
                - apigateway:GET
                - autoscaling:DescribeAutoScalingNotificationTypes
                - autoscaling:Describe*
                - application-autoscaling:Describe*
                - resource-groups:GetGroupQuery",
                - resource-groups:Search*
                - resource-groups:List*
                - ds:List*
                - ds:Describe*
                - ds:Get*
                - ds:VerifyTrust
                - applicationinsights:Describe*
                - applicationinsights:List*
                - trustedadvisor:Describe*
                - sts:Get*
                - events:Describe*
                - events:List*
                - events:TestEventPattern
                - datapipeline:Get*
                - datapipeline:EvaluateExpression
                - datapipeline:ListPipelines
                - datapipeline:QueryObjects
                - datapipeline:Describe*
                - datapipeline:ValidatePipelineDefinition
                - ecs:List*
                - ecs:Describe*
                - config:Get*
                - config:Describe*
                - config:SelectResourceConfig
                - config:Batch*
                - config:List*
                - ram:List*
                - ram:GetResource*
                - ecr:Get*
                - ecr:Batch*
                - ecr:Describe*
                - ecr:List*
                - sqs:List*
                - sqs:Get*
                - sqs:ReceiveMessage
                - es:Describe*
                - es:ESHttp*
                - es:List*
                - es:Get*
                - rds:Describe*
                - firehose:Describe*
                - firehose:List*
                - kinesisvideo:List*
                - kinesisvideo:Get*
                - kinesisvideo:DescribeStream
                - kinesisanalytics:List*
                - kinesisanalytics:DiscoverInputSchema
                - kinesisanalytics:DescribeApplication
                - kinesis:List*
                - kinesis:SubscribeToShard
                - kinesis:Describe*
                - kinesis:Get*
                - states:List*
                - states:Describe*
                - states:GetExecutionHistory
                - ssm:List*
                - ssm:Describe*
                - ssm:Get*
                - ssm:PutConfigurePackageResult
                - ssm:List*
                - codedeploy:Get*
                - codedeploy:Batch*
                - codedeploy:List*
                - secretsmanager:Get*
                - secretsmanager:DescribeSecret
                - secretsmanager:List*
                - ws-marketplace-management:view*
                - waf-regional:Get*
                - waf-regional:List*
                - route53resolver:Get*
                - route53resolver:List*
                - elasticache:Describe*
                - elasticache:List*
                - appmesh:Describe*
                - appmesh:List*
                - mobiletargeting:Get
                - mobiletargeting:PhoneNumberValidate
                - mobiletargeting:List*
                - cognito-idp:AdminGetDevice
                - cognito-idp:AdminGetUser
                - cognito-idp:AdminListUserAuthEvents
                - cognito-idp:AdminListDevices
                - cognito-idp:AdminListGroupsForUser
                - cognito-idp:List*
                - cognito-idp:Get*
                - cognito-idp:Describe*
                - cognito-identity:Describe*
                - cognito-identity:LookupDeveloperIdentity
                - cognito-identity:List*
                - cognito-identity:Get*
                - acm:ExportCertificate
                - acm:DescribeCertificate
                - acm:GetCertificate
                - acm:List*
                - sso:Describe*
                - sso:List*
                - sso:Get*
                - sso:Search*
                - dynamodb:BatchGetItem
                - dynamodb:ConditionCheckItem
                - dynamodb:List*
                - dynamodb:Scan
                - dynamodb:Query
                - dynamodb:Describe*
                - dynamodb:Get*
                - servicediscovery:List*
                - servicediscovery:Get*
                - servicediscovery:DiscoverInstances
                - elasticmapreduce:Describe*
                - elasticmapreduce:List*
                - elasticmapreduce:ViewEventsFromAllClustersInConsole
      Roles:
      - Ref: DataScienceRole

  DataEngineerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Join:
          - ''
          - - AWS_
            - Ref: AccountAlias
            - _Developer_
            - Ref: AWS::AccountId
      AssumeRolePolicyDocument:
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Federated:
              Fn::Join:
              - ''
              - - 'arn:aws:iam::'
                - Ref: AWS::AccountId
                - ":saml-provider/Gsuite"
          Action: sts:AssumeRoleWithSAML
          Condition:
            StringEquals:
              SAML:aud: https://signin.aws.amazon.com/saml

  IAMDataEngineerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
            - Effect: Allow
              Resource: "*"
              Action:
                - glue:Get*
                - glue:Batch*
                - glue:TagResource
                - glue:List*
                - glue:Get*
                - tag:Get*
                - cloudwatch:DescribeAlarmHistory
                - cloudwatch:Get*
                - cloudwatch:Describe*
                - cloudwatch:List*
                - logs:ListTagsLogGroup
                - logs:Describe*
                - logs:Get*
                - logs:StartQuery
                - logs:StopQuery
                - logs:TestMetricFilter
                - logs:Get*
                - logs:FilterLogEvents
                - health:Describe*
                - s3:List*
                - s3:Get*
                - s3:HeadBucket
                - s3:DescribeJob
                - iam:Generate*
                - iam:Get*
                - iam:List*
                - iam:Simulate*
                - athena:Get*
                - athena:List*
                - athena:Batch*
                - sns:ListTopics
                - sns:GetTopicAttributes
                - sns:ListTagsForResource
                - sns:List*
                - sns:Get*
                - sns:CheckIfPhoneNumberIsOptedOut
                - sns:List*
                - autoscaling:DescribeAutoScalingNotificationTypes
                - autoscaling:Describe*
                - trustedadvisor:Describe*
                - ec2:Get*
                - ec2:List*
                - ec2:Describe*
                - elasticloadbalancing:Describe*
                - kms:Get*
                - kms:Describe*
                - kms:List*
                - cloudtrail:Get*
                - lambda:List*
                - lambda:Get*
                - apigateway:GET
                - sqs:List*
                - sqs:Get*
                - sqs:ReceiveMessage
                - events:Describe*
                - events:List*
                - events:TestEventPattern
                - ds:List*
                - ds:Describe*
                - ds:Get*
                - ds:VerifyTrust
                - organizations:List*
                - organizations:Describe*
                - aws-portal:View*
                - rds:Describe*
                - ram:List*
                - ram:GetResource*
                - secretsmanager:Get*
                - secretsmanager:DescribeSecret
                - secretsmanager:List*
      Roles:
      - Ref: DataEngineerRole

